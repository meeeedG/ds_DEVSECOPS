name: DevSecOps Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sast:
    name: Analyse SAST du code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit SAST
        run: |
          bandit -r api -f json -o bandit-report.json || true

      - name: Fail if critical SAST findings
        run: |
          if [ ! -f bandit-report.json ]; then
            echo "Warning: bandit-report.json not found. Skipping check."
            exit 0
          fi
          HIGH_SEVERITY=$(jq '[.results[]? | select(.issue_severity == "HIGH")] | length' bandit-report.json 2>/dev/null || echo "0")
          if [ -z "$HIGH_SEVERITY" ] || [ "$HIGH_SEVERITY" = "null" ]; then
            HIGH_SEVERITY=0
          fi
          if [ "$HIGH_SEVERITY" -gt 0 ]; then
            echo "High severity SAST findings detected: $HIGH_SEVERITY issue(s). Failing the build."
            echo "Review the bandit-report.json for details."
            exit 1
          fi
          echo "No high severity SAST findings detected. Build can proceed."

  python-security:
    name: Analyse de sécurité Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: Install safety
        run: pip install safety

      - name: Install requirements
        run: pip install -r requirements.txt

      - name: Scan dependencies with safety
        run: |
          safety check -r requirements.txt --json > safety-report.json || true

      - name: Fail if critical dependency vulnerabilities
        run: |
          if [ ! -f safety-report.json ]; then
            echo "Warning: safety-report.json not found. Skipping check."
            exit 0
          fi
          CRITICAL=$(jq '[.[]? | select(.vuln_severity == "critical")] | length' safety-report.json 2>/dev/null || echo "0")
          if [ -z "$CRITICAL" ] || [ "$CRITICAL" = "null" ]; then
            CRITICAL=0
          fi
          if [ "$CRITICAL" -gt 0 ]; then
            echo "Critical vulnerabilities in dependencies detected: $CRITICAL issue(s). Failing the build."
            echo "Review the safety-report.json for details."
            exit 1
          fi
          echo "No critical dependency vulnerabilities detected. Build can proceed."

  docker-vuln-scan:
    name: Scan de vulnérabilités de l’image Docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: docker build -t myapp-devsecops:latest .

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@v0.15.0
        with:
          image-ref: myapp-devsecops:latest
          format: "json"
          output: "trivy-report.json"
          ignore-unfixed: true

      - name: Fail if critical Docker image vulnerabilities
        run: |
          if [ ! -f trivy-report.json ]; then
            echo "Warning: trivy-report.json not found. Skipping check."
            exit 0
          fi
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-report.json 2>/dev/null || echo "0")
          if [ -z "$CRITICAL" ] || [ "$CRITICAL" = "null" ]; then
            CRITICAL=0
          fi
          if [ "$CRITICAL" -gt 0 ]; then
            echo "Critical vulnerabilities found in Docker image: $CRITICAL issue(s). Failing the build."
            echo "Review the trivy-report.json for details."
            exit 1
          fi
          echo "No critical Docker image vulnerabilities detected. Build can proceed."
